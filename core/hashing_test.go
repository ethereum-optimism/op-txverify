package core

import (
	"testing"
)

func TestCalculateDomainHash(t *testing.T) {
	testCases := []struct {
		name     string
		tx       SafeTransaction
		expected string
	}{
		{
			name: "Ethereum Mainnet Safe 1",
			tx: SafeTransaction{
				Safe:  "0x847B5c174615B1B7fDF770882256e2D3E95b9D92",
				Chain: 1,
			},
			expected: "0xa4a9c312badf3fcaa05eafe5dc9bee8bd9316c78ee8b0bebe3115bb21b732672",
		},
		{
			name: "OP Mainnet Safe 1",
			tx: SafeTransaction{
				Safe:  "0xE2Ed962948005AB01F2cEfE8326a0730B7D268af",
				Chain: 10,
			},
			expected: "0x2d170d0f028e39b4926fa91cf7bbb44ef0e203f3995905ec6f1bdd3c657edfb3",
		},
		{
			name: "OP Mainnet Safe 2",
			tx: SafeTransaction{
				Safe:  "0x2501c477D0A35545a387Aa4A3EEe4292A9a8B3F0",
				Chain: 10,
			},
			expected: "0xb34978142f4478f3e5633915597a756daa58a1a59a3e0234f9acd5444f1ca70e",
		},
		{
			name: "Sepolia Safe 1",
			tx: SafeTransaction{
				Safe:  "0xf64bc17485f0B4Ea5F06A96514182FC4cB561977",
				Chain: 11155111,
			},
			expected: "0xbe081970e9fc104bd1ea27e375cd21ec7bb1eec56bfe43347c3e36c5d27b8533",
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			hash, err := CalculateDomainHash(tc.tx)
			if err != nil {
				t.Fatalf("Failed to calculate domain hash: %v", err)
			}

			if hash != tc.expected {
				t.Errorf("Domain hash mismatch. Got %s, want %s", hash, tc.expected)
			}
		})
	}
}

func TestCalculateMessageHash(t *testing.T) {
	testCases := []struct {
		name     string
		tx       SafeTransaction
		expected string
	}{
		{
			name: "Ethereum Mainnet Safe Tx 1",
			tx: SafeTransaction{
				Safe:           "0x847B5c174615B1B7fDF770882256e2D3E95b9D92",
				To:             "0xcA11bde05977b3631167028862bE2a173976CA11",
				Value:          0,
				Data:           "0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024d4d9bdcd493ad64b8f788ed9808c7bf527a10a017d9f263bb7889868ce18b451d685762d00000000000000000000000000000000000000000000000000000000",
				Operation:      1,
				SafeTxGas:      0,
				BaseGas:        0,
				GasPrice:       0,
				GasToken:       "0x0000000000000000000000000000000000000000",
				RefundReceiver: "0x0000000000000000000000000000000000000000",
				Nonce:          15,
				Chain:          1,
			},
			expected: "0xa6d60aba6b1426cec097593348a9d36ed42ddd1ac52f1b05a5f46a9c0401a11a",
		},
		{
			name: "Ethereum Mainnet Safe Tx 2",
			tx: SafeTransaction{
				Safe:           "0x847B5c174615B1B7fDF770882256e2D3E95b9D92",
				To:             "0xcA11bde05977b3631167028862bE2a173976CA11",
				Value:          0,
				Data:           "0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000005a0aae59d09fccbddb6c6cceb07b7279367c3d2a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024d4d9bdcdc94a72f6ae0da3b87a2ecb6e6ce52608c8a9d722a1b5f5f46ed9cc70a54f8a0300000000000000000000000000000000000000000000000000000000",
				Operation:      1,
				SafeTxGas:      0,
				BaseGas:        0,
				GasPrice:       0,
				GasToken:       "0x0000000000000000000000000000000000000000",
				RefundReceiver: "0x0000000000000000000000000000000000000000",
				Nonce:          14,
				Chain:          1,
			},
			expected: "0x80448b82d41f9dcdf97f973fc7f7dc60c176ae0ef1a640f46cf9906ccad861cf",
		},
		{
			name: "Ethereum Mainnet Safe Tx 3",
			tx: SafeTransaction{
				Safe:           "0x5a0Aae59D09fccBdDb6C6CcEB07B7279367C3d2A",
				To:             "0xcA11bde05977b3631167028862bE2a173976CA11",
				Value:          0,
				Data:           "0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000022000000000000000000000000089889b569c3a505f3640ee1bd0ac1d557f436d2a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004499a88ec40000000000000000000000007a8ed66b319911a0f3e7288bddab30d9c0c875c3000000000000000000000000d81f43edbcacb4c29a9ba38a13ee5d79278270cc000000000000000000000000000000000000000000000000000000000000000000000000000000007a8ed66b319911a0f3e7288bddab30d9c0c875c30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000444e91db08000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000089889b569c3a505f3640ee1bd0ac1d557f436d2a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003249623609d0000000000000000000000007a8ed66b319911a0f3e7288bddab30d9c0c875c3000000000000000000000000ab9d6cb7a427c0765163a7f45bb91cafe5f2d37500000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000284db9040fa000000000000000000000000509182ec226b3b71d36a3255a80ef0b1a9d4303300000000000000000000000000000000000000000000000000000000000026080000000000000000000000000000000000000000000000000000000000177fef0000000000000000000000006776be80dbada6a02b5f2095cf13734ac303b8d10000000000000000000000000000000000000000000000000000000002625a000000000000000000000000007c2bd59ee2a2c7391c9a240132f26071e95462620000000000000000000000000000000000000000000000000000000001312d00000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000003b9aca0000000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000ffffffffffffffffffffffffffffffff000000000000000000000000008dc74cecc9deda8595b2fe210ce5979f0bfa8e0000000000000000000000009cf951e3f74b644e621b36ca9cea147a78d4c39f0000000000000000000000005933e323be8896dfacd1cd671442f27daa10a053000000000000000000000000eb9bf100225c214efc3e7c651ebbadcf85177607000000000000000000000000512a3d2c7a43bd9261d2b8e8c9c70d4bd4d503c000000000000000000000000088e529a6ccd302c948689cd5156c83d4614fae92000000000000000000000000c1047e30efc9e172cfe7aa0219895b6a43fc415f000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
				Operation:      1,
				SafeTxGas:      0,
				BaseGas:        0,
				GasPrice:       0,
				GasToken:       "0x0000000000000000000000000000000000000000",
				RefundReceiver: "0x0000000000000000000000000000000000000000",
				Nonce:          9,
				Chain:          1,
			},
			expected: "0xe68d10cbe161b2d3d738b8ac5df1ca9f13f5c1c1843375410fa7530878106670",
		},
		{
			name: "Sepolia Safe Tx 1",
			tx: SafeTransaction{
				Safe:           "0xf64bc17485f0B4Ea5F06A96514182FC4cB561977",
				To:             "0xcA11bde05977b3631167028862bE2a173976CA11",
				Value:          0,
				Data:           "0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000001eb2ffc903729a0f03966b917003800b145f56e2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024d4d9bdcd076db0a8758739afdd098a3d9fed5147eb55f363cd85167c1b3e5f334d317f3e00000000000000000000000000000000000000000000000000000000",
				Operation:      1,
				SafeTxGas:      0,
				BaseGas:        0,
				GasPrice:       0,
				GasToken:       "0x0000000000000000000000000000000000000000",
				RefundReceiver: "0x0000000000000000000000000000000000000000",
				Nonce:          30,
				Chain:          11155111,
			},
			expected: "0x2044f4436f0a27ce0697bc3fadb46ee88568d74fe8abaf1a6a31ce5ecf888c5a",
		},
		{
			name: "OP Mainnet Safe Tx 1",
			tx: SafeTransaction{
				Safe:           "0x2501c477D0A35545a387Aa4A3EEe4292A9a8B3F0",
				To:             "0x4200000000000000000000000000000000000042",
				Value:          0,
				Data:           "0xa9059cbb0000000000000000000000008b8b2f214d92527bf1b1148dc2e609a4c1c2fd69000000000000000000000000000000000000000000034f086f3b33b684000000",
				Operation:      0,
				SafeTxGas:      0,
				BaseGas:        0,
				GasPrice:       0,
				GasToken:       "0x0000000000000000000000000000000000000000",
				RefundReceiver: "0x0000000000000000000000000000000000000000",
				Nonce:          155,
				Chain:          10,
			},
			expected: "0xc1613ba7c92e30a3facf5747b8cc8f8a5c8f135b5291c0d78b2fcffc838cc7e5",
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			hash, err := CalculateMessageHash(tc.tx)
			if err != nil {
				t.Fatalf("Failed to calculate message hash: %v", err)
			}

			if hash != tc.expected {
				t.Errorf("Message hash mismatch. Got %s, want %s", hash, tc.expected)
			}
		})
	}
}
